<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Voice to Text</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Link CSS -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>üéôÔ∏è Realtime Voice to Text</h2>
  <div class="container">
    <!-- Kolom Kiri -->
    <div class="column transcript-col">
      <textarea id="transcript" placeholder="Transkrip akan muncul di sini..." readonly></textarea>
      <div class="btn-group">
        <button id="startBtn">Mulai</button>
        <button id="continueBtn" disabled>Lanjut</button>
        <button id="stopBtn" disabled>Stop</button>
      </div>
    </div>
    <!-- Kolom Kanan -->
    <div class="column summary-col">
      <div class="summary-header">
        <span id="timestamp" class="timestamp"></span>
        <div class="header-right">
          <span id="connectionStatus" class="connection-status" title="Status koneksi ke backend">üü¢ Terhubung</span>
          <span id="charCount" class="char-count"></span>
        </div>
      </div>
      <div id="progressBar" class="progress-bar" style="display: none;">
        <div id="progressFill" class="progress-fill"></div>
      </div>
      <div class="editor-toolbar">
        <button type="button" id="boldBtn" title="Bold (Ctrl+B)"><b>B</b></button>
        <button type="button" id="italicBtn" title="Italic (Ctrl+I)"><i>I</i></button>
        <button type="button" id="underlineBtn" title="Underline (Ctrl+U)"><u>U</u></button>
        <span class="toolbar-sep"></span>
        <button type="button" id="ulBtn" title="Bullet List">‚Ä¢ List</button>
        <button type="button" id="olBtn" title="Numbered List">1. List</button>
        <span class="toolbar-sep"></span>
        <button type="button" id="undoBtn" title="Undo (Ctrl+Z)">Undo</button>
        <button type="button" id="redoBtn" title="Redo (Ctrl+Y)">Redo</button>
        <button type="button" id="clearFormatBtn" title="Clear formatting">Clear</button>
      </div>
      <div id="summaryEditor" class="editor" contenteditable="true" data-placeholder="Ringkasan akan muncul di sini..."></div>
      <div class="btn-group">
        <button id="summarizeBtn" disabled title="Kirim transkrip untuk dibuatkan ringkasan (Ctrl+Enter)">Kirim & Ringkas</button>
        <button id="copyBtn" disabled title="Salin ringkasan ke clipboard (Ctrl+C)">Salin</button>
        <button id="clearBtn" title="Hapus ringkasan dan data tersimpan">Hapus</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>
  <script>
  let recognition;
  let transcriptArea = document.getElementById('transcript');
  let summaryEditor = document.getElementById('summaryEditor');
  let startBtn = document.getElementById('startBtn');
  let continueBtn = document.getElementById('continueBtn');
  let stopBtn = document.getElementById('stopBtn');
  let summarizeBtn = document.getElementById('summarizeBtn');
  let copyBtn = document.getElementById('copyBtn');
  let clearBtn = document.getElementById('clearBtn');
  let boldBtn = document.getElementById('boldBtn');
  let italicBtn = document.getElementById('italicBtn');
  let underlineBtn = document.getElementById('underlineBtn');
  let ulBtn = document.getElementById('ulBtn');
  let olBtn = document.getElementById('olBtn');
  let undoBtn = document.getElementById('undoBtn');
  let redoBtn = document.getElementById('redoBtn');
  let clearFormatBtn = document.getElementById('clearFormatBtn');
  let timestamp = document.getElementById('timestamp');
  let charCount = document.getElementById('charCount');
  let connectionStatus = document.getElementById('connectionStatus');
  let progressBar = document.getElementById('progressBar');
  let progressFill = document.getElementById('progressFill');
  let toast = document.getElementById('toast');
  let manualStop = false;
  let fullTranscript = "";
  let autoSaveTimeout;


  // Convert spoken punctuation into symbols (ID dictation)
  function applyPunctuation(text) {
    let t = text;
    const rules = [
      { re: /\b(tanda\s+koma)\b/gi, sub: ',' },
      { re: /\b(titik\s+koma)\b/gi, sub: ';' },
      { re: /\b(titik\s+dua)\b/gi, sub: ':' },
      { re: /\b(tanda\s+tanya)\b/gi, sub: '?' },
      { re: /\b(tanda\s+seru)\b/gi, sub: '!' },
      { re: /\b(kurung\s+buka)\b/gi, sub: '(' },
      { re: /\b(kurung\s+tutup)\b/gi, sub: ')' },
      { re: /\b(petik\s+dua\s+buka|petik\s+dua)\b/gi, sub: '"' },
      { re: /\b(petik\s+dua\s+tutup)\b/gi, sub: '"' },
      { re: /\b(petik\s+satu\s+buka|petik\s+satu)\b/gi, sub: '\'' },
      { re: /\b(petik\s+satu\s+tutup)\b/gi, sub: '\'' },
      { re: /\b(garis\s+miring)\b/gi, sub: '/' },
      { re: /\b(strip|tanda\s+hubung)\b/gi, sub: '-' },
      { re: /\b(koma)\b/gi, sub: ',' },
      { re: /\b(titik)\b/gi, sub: '.' },
      { re: /\b(baris\s+baru|enter|paragraf\s+baru)\b/gi, sub: '\n' }
    ];
    for (const { re, sub } of rules) {
      t = t.replace(re, sub);
    }
    return normalizeSpacing(t);
  }

  function normalizeSpacing(t) {
    // trim extra spaces
    t = t.replace(/\s+([,.;:!?])/g, '$1'); // no space before punctuation
    t = t.replace(/([,.;:!?])(?!\s|$)/g, '$1 '); // ensure one space after
    t = t.replace(/\(\s+/g, '(').replace(/\s+\)/g, ')'); // tidy parentheses
    t = t.replace(/ {2,}/g, ' ');
    t = t.replace(/\s+\n/g, '\n');
    return t;
  }

  // Medical term autocorrection for common Indonesian phonetic variants ‚Üí English terms
  function applyMedicalCorrections(text) {
    let t = text;
    const rules = [
      // axillary tissue variants
      { re: /\baks(?:e|i)l(?:ar(?:i|y)|er|ari|ariy|ari\b|ary|lari|leri)?\s+t(?:i|is|isy|isyuu|isyu|ishu|iss)u(?:e)?\b/gi, sub: 'axillary tissue' },
      { re: /\baks(?:e|i)l(?:ar(?:i|y)|er|ari|ary|lari|leri)\b/gi, sub: 'axillary' },
      { re: /\btis(?:u|yu|yuu|su|sue)\b/gi, sub: 'tissue' },
      // axilla
      { re: /\baksila\b/gi, sub: 'axilla' },
      // optional: normalize common markers written as words
      { re: /\bher\s*dua\b/gi, sub: 'HER2' },
      { re: /\bki\s*enam\s*puluh\s*tujuh\b/gi, sub: 'Ki-67' }
    ];
    for (const { re, sub } of rules) {
      t = t.replace(re, sub);
    }
    return t;
  }

  // Basic Markdown ‚Üí HTML to render bullets and emphasis nicely
  function convertMarkdownBasic(md) {
    const escapeHtml = (s) => s
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');

    const inline = (s) => {
      let x = escapeHtml(s);
      x = x.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      x = x.replace(/__(.+?)__/g, '<strong>$1</strong>');
      x = x.replace(/\*(.+?)\*/g, '<em>$1</em>');
      x = x.replace(/_(.+?)_/g, '<em>$1</em>');
      return x;
    };

    const lines = md.split(/\r?\n/);
    let html = '';
    let inUl = false;
    let inOl = false;
    const closeLists = () => {
      if (inUl) { html += '</ul>'; inUl = false; }
      if (inOl) { html += '</ol>'; inOl = false; }
    };

    for (const raw of lines) {
      const line = raw || '';
      if (/^\s*-\s+/.test(line)) {
        if (!inUl) { closeLists(); html += '<ul>'; inUl = true; }
        html += `<li>${inline(line.replace(/^\s*-\s+/, ''))}</li>`;
        continue;
      }
      if (/^\s*\d+\.\s+/.test(line)) {
        if (!inOl) { closeLists(); html += '<ol>'; inOl = true; }
        html += `<li>${inline(line.replace(/^\s*\d+\.\s+/, ''))}</li>`;
        continue;
      }
      closeLists();
      if (line.trim() === '') { html += '<br/>'; continue; }
      html += `<p>${inline(line)}</p>`;
    }
    closeLists();
    return html;
  }


  // Auto-save functionality
  function setupAutoSave() {
    summaryEditor.addEventListener('input', function() {
      clearTimeout(autoSaveTimeout);
      autoSaveTimeout = setTimeout(() => {
        const text = summaryEditor.innerText.trim();
        const html = summaryEditor.innerHTML.trim();
        if (text.length > 0) {
          localStorage.setItem('autoSaveSummary', text);
          localStorage.setItem('autoSaveSummaryHtml', html);
          localStorage.setItem('autoSaveTimestamp', new Date().toLocaleString());
          showToast("Auto-save berhasil!", "info");
        }
      }, 3000); // Auto-save after 3 seconds of inactivity
    });
  }

  // Load auto-saved content
  function loadAutoSave() {
    const autoSavedText = localStorage.getItem('autoSaveSummary');
    const autoSavedHtml = localStorage.getItem('autoSaveSummaryHtml');
    if (autoSavedText && !localStorage.getItem('savedSummary')) {
      summaryEditor.innerHTML = autoSavedHtml || autoSavedText;
      updateCountDisplay(autoSavedText);
      copyBtn.disabled = false;
      showToast("Auto-saved content restored!", "info");
    }
  }

  // Toast notification function
  function showToast(message, type = 'success') {
    toast.textContent = message;
    toast.className = `toast ${type}`;
    toast.style.display = 'block';
    
    setTimeout(() => {
      toast.style.display = 'none';
    }, 3000);
  }

  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    // (Ctrl+S removed)
    
    // Ctrl+C or Cmd+C to copy (when summary area is focused)
    if ((e.ctrlKey || e.metaKey) && e.key === 'c' && document.activeElement === summaryEditor) {
      if (!copyBtn.disabled) {
        e.preventDefault();
        copyBtn.click();
      }
    }
    
    // Ctrl+Enter or Cmd+Enter to summarize
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      if (!summarizeBtn.disabled) {
        summarizeBtn.click();
      }
    }
  });

  // Update connection status
  function updateConnectionStatus(isConnected) {
    if (isConnected) {
      connectionStatus.textContent = "üü¢ Terhubung";
      connectionStatus.title = "Status koneksi ke backend";
      connectionStatus.className = "connection-status connected";
    } else {
      connectionStatus.textContent = "üî¥ Terputus";
      connectionStatus.title = "Tidak dapat terhubung ke backend";
      connectionStatus.className = "connection-status disconnected";
    }
  }

  // Check backend connectivity
  function checkBackendConnection() {
    fetch('/summarize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: "test" })
    })
    .then(response => {
      updateConnectionStatus(true);
    })
    .catch(() => {
      updateConnectionStatus(false);
    });
  }

  // Check connection on page load
  checkBackendConnection();
  
  // Setup auto-save
  setupAutoSave();

  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    alert("Browser Anda tidak mendukung Web Speech API. Silakan gunakan Google Chrome.");
  } else {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'id-ID';
    recognition.continuous = true;
    recognition.interimResults = true;

    recognition.onresult = function(event) {
      let interim = '';
      for (let i = event.resultIndex; i < event.results.length; ++i) {
        const chunk = applyMedicalCorrections(applyPunctuation(event.results[i][0].transcript || ''));
        if (event.results[i].isFinal) {
          fullTranscript += chunk + ' ';
        } else {
          interim += chunk;
        }
      }
      transcriptArea.value = fullTranscript + interim;
      summarizeBtn.disabled = (transcriptArea.value.trim() === "");
    };

    recognition.onstart = function() {
      // UI state when recognition starts
      startBtn.disabled = true;
      continueBtn.disabled = true;
      stopBtn.disabled = false;
      summaryEditor.innerHTML = '';
      fullTranscript = "";
      transcriptArea.value = '';
    };

    recognition.onend = function() {
      startBtn.disabled = false;
      stopBtn.disabled = true;
      summarizeBtn.disabled = (transcriptArea.value.trim() === "");
      if (!manualStop) {
        recognition.start();
      }
    };

    startBtn.onclick = function() {
      transcriptArea.value = '';
      summaryEditor.innerHTML = '';
      manualStop = false;
      fullTranscript = "";
      continueBtn.disabled = true;
      try {
        recognition.start();
      } catch (err) {
        console.error('Failed to start recognition:', err);
        showToast('Tidak bisa mulai: izin mikrofon diblokir atau sudah berjalan.', 'error');
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    };

    continueBtn.onclick = function() {
      manualStop = false;
      recognition.start();
    };

    stopBtn.onclick = function() {
      manualStop = true;
      recognition.stop();
    };

    // Handle recognition errors so the UI does not get stuck
    recognition.onerror = function(event) {
      console.error('SpeechRecognition error:', event);
      showToast(`Gagal memulai/berjalan: ${event.error}`, 'error');
      startBtn.disabled = false;
      continueBtn.disabled = (transcriptArea.value.trim() === "");
      stopBtn.disabled = true;
    };

    

    recognition.onend = function() {
      startBtn.disabled = false;
      stopBtn.disabled = true;
      summarizeBtn.disabled = (transcriptArea.value.trim() === "");
      continueBtn.disabled = (transcriptArea.value.trim() === "");
      if (!manualStop) {
        recognition.start();
      }
    };

    summarizeBtn.onclick = function() {
      let text = transcriptArea.value.trim();
      if (text === "") return;
      
      summaryEditor.innerText = 'Memproses ringkasan...';
      charCount.textContent = "Memproses...";
      summarizeBtn.disabled = true;
      copyBtn.disabled = true;
      
      // Show progress bar
      const progressInterval = showProgress();
      
      // Add loading spinner (via CSS class)
      summaryEditor.classList.add('loading');
      
      fetch('/summarize', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: text })
      })
      .then(response => response.json())
      .then(data => {
        clearInterval(progressInterval);
        completeProgress();
        
        // Try to render simple markdown-like output
        const raw = (data.summary || '').trim();
        const html = convertMarkdownBasic(raw);
        summaryEditor.innerHTML = html;
        updateCountDisplay(summaryEditor.innerText.trim());
        copyBtn.disabled = false; // Enable copy button after getting summary
        summarizeBtn.disabled = false; // Re-enable summarize button
        showToast("Ringkasan berhasil dibuat!", "success");
        
        // Remove loading spinner
        summaryEditor.classList.remove('loading');
      })
      .catch(() => {
        clearInterval(progressInterval);
        hideProgress();
        
        summaryEditor.innerText = 'Gagal mengambil ringkasan dari backend.';
        charCount.textContent = "Error";
        copyBtn.disabled = true;
        summarizeBtn.disabled = false; // Re-enable summarize button
        showToast("Gagal mengambil ringkasan dari backend.", "error");
        
        // Remove loading spinner
        summaryEditor.classList.remove('loading');
      });
    };

    // Enable buttons when user starts editing the summary
    summaryEditor.addEventListener('input', function() {
      const text = summaryEditor.innerText.trim();
      updateCountDisplay(text);
      
      if (text !== "") {
        copyBtn.disabled = false;
      } else {
        copyBtn.disabled = true;
      }
    });

    // Copy button functionality
    copyBtn.onclick = function() {
      const text = summaryEditor.innerText.trim();
      const html = summaryEditor.innerHTML.trim();
      if (text === "") return;
      
      // Try to copy as HTML (preserve formatting)
      if (navigator.clipboard && navigator.clipboard.write) {
        const type = 'text/html';
        const blob = new Blob([html], { type });
        const data = [new ClipboardItem({ [type]: blob })];
        navigator.clipboard.write(data).then(function() {
          showToast("Ringkasan (dengan format) disalin!", "success");
        }).catch(function() {
          // Fallback to plain text
          navigator.clipboard.writeText(text).then(function() {
            showToast("Ringkasan disalin sebagai teks!", "success");
          }).catch(function() {
            // Final fallback: execCommand selection
            const range = document.createRange();
            range.selectNodeContents(summaryEditor);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
            document.execCommand('copy');
            showToast("Ringkasan disalin!", "success");
          });
        });
      } else {
        // Older browsers: plain text
        navigator.clipboard.writeText(text).then(function() {
          showToast("Ringkasan disalin sebagai teks!", "success");
        }).catch(function() {
          const range = document.createRange();
          range.selectNodeContents(summaryEditor);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
          document.execCommand('copy');
          showToast("Ringkasan disalin!", "success");
        });
      }
    };

    // (Manual save removed)

    // Load saved summary on page load
    window.addEventListener('load', function() {
      const savedSummary = localStorage.getItem('savedSummary');
      const savedSummaryHtml = localStorage.getItem('savedSummaryHtml');
      const savedTimestamp = localStorage.getItem('savedTimestamp');
      
      if (savedSummary) {
        summaryEditor.innerHTML = savedSummaryHtml || savedSummary;
        copyBtn.disabled = false;
        updateCountDisplay(savedSummary);
        if (savedTimestamp) {
          timestamp.textContent = `Terakhir disimpan: ${savedTimestamp}`;
        }
        console.log('Loaded saved summary from:', savedTimestamp);
        showToast("Ringkasan tersimpan berhasil dimuat!", "info");
      }
      loadAutoSave(); // Load auto-saved content
    });

    // Clear button functionality
    clearBtn.onclick = function() {
      if (confirm('Apakah Anda yakin ingin menghapus ringkasan ini?')) {
        summaryEditor.innerHTML = '';
        timestamp.textContent = '';
        charCount.textContent = '';
        localStorage.removeItem('savedSummary');
        localStorage.removeItem('savedSummaryHtml');
        localStorage.removeItem('savedTimestamp');
        localStorage.removeItem('autoSaveSummary');
        localStorage.removeItem('autoSaveSummaryHtml');
        localStorage.removeItem('autoSaveTimestamp');
        copyBtn.disabled = true;
        showToast("Ringkasan berhasil dihapus!", "info");
      }
    };
  }

  // Progress bar functions
  function showProgress() {
    progressBar.style.display = 'block';
    progressFill.style.width = '0%';
    
    let progress = 0;
    const interval = setInterval(() => {
      progress += Math.random() * 15;
      if (progress > 90) progress = 90;
      progressFill.style.width = progress + '%';
    }, 200);
    
    return interval;
  }
  
  function hideProgress() {
    progressBar.style.display = 'none';
    progressFill.style.width = '0%';
  }
  
  function completeProgress() {
    progressFill.style.width = '100%';
    setTimeout(() => {
      hideProgress();
    }, 500);
  }

  // Calculate reading time (average 200 words per minute)
  function calculateReadingTime(text) {
    const wordCount = text.split(/\s+/).filter(word => word.length > 0).length;
    const readingTimeMinutes = Math.ceil(wordCount / 200);
    return readingTimeMinutes;
  }

  // Update count display with reading time
  function updateCountDisplay(text) {
    if (text.length > 0) {
      const wordCount = text.split(/\s+/).filter(word => word.length > 0).length;
      const readingTime = calculateReadingTime(text);
      charCount.textContent = `${text.length} karakter, ${wordCount} kata, ~${readingTime} menit baca`;
    } else {
      charCount.textContent = '';
    }
  }

  // Toolbar actions using document.execCommand for simplicity
  function exec(cmd, value = null) {
    document.execCommand(cmd, false, value);
    summaryEditor.focus();
  }
  boldBtn.onclick = () => exec('bold');
  italicBtn.onclick = () => exec('italic');
  underlineBtn.onclick = () => exec('underline');
  ulBtn.onclick = () => exec('insertUnorderedList');
  olBtn.onclick = () => exec('insertOrderedList');
  undoBtn.onclick = () => exec('undo');
  redoBtn.onclick = () => exec('redo');
  clearFormatBtn.onclick = () => exec('removeFormat');

  // Keyboard: Ctrl+B/I/U for formatting inside editor
  summaryEditor.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'b') { e.preventDefault(); exec('bold'); }
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'i') { e.preventDefault(); exec('italic'); }
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'u') { e.preventDefault(); exec('underline'); }
  });
  </script>
</body>
</html>
